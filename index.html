<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8"/>
<meta name="theme-color" content="#4A7C59"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="hisobIA"/>
<link rel="apple-touch-icon" href="/icons/icon-192.png"/>
<link rel="manifest" href="/manifest.json"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<title>PulTrack</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap');

:root {
  --bg:       #F5F2EE;
  --surface:  #FFFFFF;
  --surface2: #EDE9E3;
  --border:   #DDD8CF;
  --text:     #2C2825;
  --text2:    #7C776F;
  --text3:    #ADA89F;
  --accent:   #4A7C59;
  --accent-l: #E8F2EC;
  --red:      #C0392B;
  --nav-h:    64px;
  --top-h:    56px;
  --radius:   16px;
  --shadow:   0 2px 12px rgba(44,40,37,0.08);
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

html, body { height:100%; overflow:hidden; }

body {
  font-family: 'Nunito', sans-serif;
  background: var(--bg);
  color: var(--text);
  max-width: 430px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
}

/* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
.topbar {
  height: var(--top-h);
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 18px;
  justify-content: space-between;
  flex-shrink: 0;
  z-index: 10;
}

/* ‚îÄ‚îÄ LOGO ‚îÄ‚îÄ */
.logo {
  font-size: 19px;
  font-weight: 800;
  letter-spacing: -0.5px;
  color: var(--text);
  display: flex;
  align-items: baseline;
  gap: 0;
  user-select: none;
}

.logo-ia{
  color: var(--accent);
  display: inline;
  position: static;
  width: auto;
  height: auto;
}

.topbar-right { display:flex; align-items:center; gap:8px; }

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.pages { flex:1; overflow:hidden; position:relative; }

.page {
  position: absolute; inset: 0;
  overflow-y: auto;
  padding: 14px 14px 10px;
  display: none;
  flex-direction: column;
  gap: 11px;
}
.page.active { display:flex; }

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.bottom-nav {
  height: var(--nav-h);
  background: var(--surface);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: stretch;
  flex-shrink: 0;
  z-index: 10;
}

.nav-btn {
  flex: 1;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 3px;
  background: none; border: none;
  cursor: pointer;
  font-family: 'Nunito', sans-serif;
  font-size: 10px; font-weight: 700;
  color: var(--text3);
  transition: color 0.18s;
  position: relative;
}
.nav-btn svg { width:21px; height:21px; stroke-width:1.8; }
.nav-btn.active { color: var(--accent); }
.nav-btn.active::before {
  content:'';
  position:absolute; top:0; left:25%; right:25%;
  height:2.5px; background:var(--accent);
  border-radius:0 0 3px 3px;
}

/* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
.card { background:var(--surface); border-radius:var(--radius); padding:15px; box-shadow:var(--shadow); }

/* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
.hero-card {
  background: var(--accent); color:white;
  border-radius: var(--radius);
  padding: 18px 16px 16px;
  position: relative; overflow: hidden;
}
.hero-card::before {
  content:''; position:absolute; top:-25px; right:-25px;
  width:110px; height:110px;
  background:rgba(255,255,255,0.07); border-radius:50%;
}
.hero-card::after {
  content:''; position:absolute; bottom:-35px; right:15px;
  width:80px; height:80px;
  background:rgba(255,255,255,0.05); border-radius:50%;
}
.hero-label { font-size:10px; font-weight:700; opacity:0.7; letter-spacing:1.2px; text-transform:uppercase; }
.hero-amount {
  font-family:'DM Mono',monospace; font-size:32px; font-weight:500;
  margin:4px 0 12px; letter-spacing:-1px; line-height:1;
}
.hero-row { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.hero-stat { background:rgba(255,255,255,0.13); border-radius:10px; padding:9px 11px; }
.hero-stat-val { font-family:'DM Mono',monospace; font-size:16px; font-weight:500; line-height:1; }
.hero-stat-lbl { font-size:10px; opacity:0.65; margin-top:3px; }

.prog-wrap { margin-top:10px; }
.prog-meta { display:flex; justify-content:space-between; font-size:10px; opacity:0.7; margin-bottom:4px; }
.prog-track { background:rgba(255,255,255,0.2); border-radius:99px; height:5px; overflow:hidden; }
.prog-fill { height:100%; border-radius:99px; background:white; transition:width 0.5s ease; }

/* ‚îÄ‚îÄ MINI STATS ‚îÄ‚îÄ */
.mini-stats { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.mini-card { background:var(--surface); border-radius:14px; padding:13px; box-shadow:var(--shadow); }
.mini-ico { width:30px; height:30px; border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:15px; margin-bottom:7px; }
.mini-val { font-family:'DM Mono',monospace; font-size:16px; color:var(--text); line-height:1; font-weight:500; }
.mini-lbl { font-size:10px; color:var(--text3); margin-top:3px; font-weight:700; letter-spacing:0.4px; }

/* ‚îÄ‚îÄ SEC TITLE ‚îÄ‚îÄ */
.sec-title { font-size:10px; font-weight:800; letter-spacing:1.2px; color:var(--text3); text-transform:uppercase; margin-bottom:8px; }

/* ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ */
.hist-list { display:flex; flex-direction:column; gap:7px; position:relative; }
.entry-card {
  background:var(--surface); border-radius:13px; padding:12px 13px;
  display:flex; align-items:center; gap:11px;
  box-shadow:0 1px 5px rgba(44,40,37,0.06);
  position:relative;
}
.entry-card.clickable { cursor:pointer; }

.entry-ico { width:38px; height:38px; border-radius:11px; display:flex; align-items:center; justify-content:center; font-size:17px; flex-shrink:0; }
.entry-info { flex:1; min-width:0; }
.entry-desc { font-size:13px; font-weight:700; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.entry-meta { font-size:10px; color:var(--text3); margin-top:2px; font-weight:600; }
.entry-right { display:flex; flex-direction:column; align-items:flex-end; gap:5px; flex-shrink:0; }
.entry-amt { font-family:'DM Mono',monospace; font-size:14px; color:var(--text); }
.del-btn { background:none; border:none; cursor:pointer; font-size:13px; color:var(--text3); padding:1px; transition:color 0.15s; }
.del-btn:hover { color:var(--red); }

/* entry context menu */
.entry-context {
  position:absolute;
  right:10px; top:50%;
  transform:translateY(-50%);
  background:var(--surface);
  border:1.5px solid var(--border);
  border-radius:10px;
  box-shadow:var(--shadow);
  display:flex;
  gap:4px;
  padding:4px;
  z-index:5;
}
.entry-context-btn {
  background:var(--bg);
  border:none;
  padding:6px 12px;
  border-radius:8px;
  font-size:11px;
  font-weight:800;
  cursor:pointer;
  transition:all 0.15s;
}
.entry-context-btn.edit { color:var(--accent); }
.entry-context-btn.delete { color:var(--red); }
.entry-context-btn:hover { opacity:0.7; }

/* filter buttons */
.filter-row {
  display:flex;
  gap:6px;
  margin-top:6px;
}
.filter-btn {
  flex:1;
  background:var(--surface);
  border:1.5px solid var(--border);
  border-radius:10px;
  padding:10px;
  font-size:11px;
  font-weight:800;
  color:var(--text2);
  cursor:pointer;
  transition:all 0.15s;
}
.filter-btn.active {
  border-color:var(--accent);
  background:var(--accent-l);
  color:var(--accent);
}

.empty-msg { text-align:center; padding:24px 16px; color:var(--text3); font-size:13px; font-weight:600; }
.empty-msg .big { font-size:28px; margin-bottom:6px; }

/* ‚îÄ‚îÄ ADD FORM ‚îÄ‚îÄ */
.add-form { display:flex; flex-direction:column; gap:10px; }
.f-row { display:flex; flex-direction:column; gap:5px; }
.f-lbl { font-size:10px; font-weight:800; color:var(--text3); letter-spacing:0.8px; text-transform:uppercase; }
.f-input {
  width:100%; border:1.5px solid var(--border); border-radius:11px;
  padding:11px 13px;
  font-family:'Nunito',sans-serif; font-size:15px; font-weight:700;
  color:var(--text); background:var(--bg); outline:none;
  transition:border-color 0.15s, background 0.15s;
}
.f-input:focus { border-color:var(--accent); background:white; }
.amt-wrap { position:relative; }
.amt-wrap .cur { position:absolute; left:13px; top:50%; transform:translateY(-50%); color:var(--text3); font-size:12px; font-weight:800; pointer-events:none; letter-spacing:0.5px; }
.amt-wrap .f-input { padding-left:44px; font-family:'DM Mono',monospace; font-size:19px; }

.cat-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; }
.cat-item {
  display:flex; flex-direction:column; align-items:center; gap:3px;
  padding:9px 4px; border-radius:11px;
  border:1.5px solid var(--border); background:var(--bg);
  cursor:pointer; font-size:10px; font-weight:800; color:var(--text2);
  transition:all 0.15s; text-align:center;
}
.cat-item .ico { font-size:19px; line-height:1; }
.cat-item.sel { border-color:var(--accent); background:var(--accent-l); color:var(--accent); }

.add-btn {
  background:var(--accent); color:white; border:none;
  border-radius:12px; padding:14px;
  font-family:'Nunito',sans-serif; font-size:15px; font-weight:800;
  cursor:pointer; transition:opacity 0.15s, transform 0.1s;
}
.add-btn:active { transform:scale(0.98); opacity:0.88; }

/* ‚îÄ‚îÄ BOSHQA (settings) ‚îÄ‚îÄ */
.settings-list {
  display:flex;
  flex-direction:column;
  gap:8px;
}
.setting-item {
  background:var(--surface);
  border-radius:13px;
  padding:14px;
  display:flex;
  cursor: pointer;
  align-items:center;
  justify-content:space-between;
  box-shadow:0 1px 5px rgba(44,40,37,0.05);
}

.setting-item:active { transform:scale(0.98); opacity:0.88; }

.setting-info { flex:1; }
.setting-name { font-size:14px; font-weight:700; color:var(--text); }
.setting-desc { font-size:11px; color:var(--text3); margin-top:2px; }
.setting-action {
  background:var(--accent-l);
  color:var(--accent);
  border:1.5px solid var(--accent);
  border-radius:10px;
  padding:8px 14px;
  font-size:12px;
  font-weight:800;
  cursor:pointer;
}
.setting-action.disabled {
  background:var(--surface2);
  color:var(--text3);
  border-color:var(--border);
  cursor:not-allowed;
}

/* ‚îÄ‚îÄ CHART (diagramma) ‚îÄ‚îÄ */
.chart-card {
  background:var(--surface);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:var(--shadow);
}
.chart-title {
  font-size:12px;
  font-weight:800;
  color:var(--text);
  margin-bottom:10px;
  letter-spacing:0.5px;
}
.chart-canvas {
  width:100%;
  height:180px;
}

/* CAT colors */
.ic-oziq      { background:#E8F5E9; }
.ic-transport { background:#E3F2FD; }
.ic-kommunal  { background:#FFF8E1; }
.ic-soglik    { background:#FCE4EC; }
.ic-kiyim     { background:#F3E5F5; }
.ic-uy        { background:#E0F2F1; }
.ic-ta ºlim    { background:#FFF3E0; }
.ic-ko ºngil   { background:#F3E5F5; }
.ic-boshqa    { background:#ECEFF1; }
.bar-oziq      { background:#4CAF50; }
.bar-transport { background:#2196F3; }
.bar-kommunal  { background:#FFC107; }
.bar-soglik    { background:#E91E63; }
.bar-kiyim     { background:#9C27B0; }
.bar-uy        { background:#00897B; }
.bar-ta ºlim    { background:#FB8C00; }
.bar-ko ºngil   { background:#7B1FA2; }
.bar-boshqa    { background:#90A4AE; }

/* ‚îÄ‚îÄ MODAL (PIN / CONFIRM) ‚îÄ‚îÄ */
.modal-backdrop {
  position: fixed; inset:0;
  background: rgba(44,40,37,0.45);
  z-index: 100;
  display: flex; align-items: flex-end; justify-content: center;
  opacity:0; pointer-events:none;
  transition: opacity 0.2s;
}
.modal-backdrop.open { opacity:1; pointer-events:all; }

.modal-sheet {
  background: var(--surface);
  border-radius: 20px 20px 0 0;
  padding: 20px 20px 32px;
  width: 100%; max-width: 430px;
  transform: translateY(100%);
  transition: transform 0.25s cubic-bezier(.4,0,.2,1);
  display: flex; flex-direction:column; gap:14px;
}
.modal-backdrop.open .modal-sheet { transform: translateY(0); }

.modal-handle {
  width:36px; height:4px; border-radius:99px;
  background:var(--border); margin:0 auto -4px;
}
.modal-title { font-size:16px; font-weight:800; text-align:center; }
.modal-sub { font-size:13px; color:var(--text3); text-align:center; font-weight:600; line-height:1.4; }

.pin-hint {
  font-size:11px; color:var(--text3); text-align:center; font-weight:600;
  background:var(--bg); border-radius:10px; padding:8px 12px;
}
.pin-hint span { color:var(--accent); font-family:'DM Mono',monospace; font-size:13px; font-weight:500; }

.pin-input {
  width:100%; border:1.5px solid var(--border); border-radius:11px;
  padding:13px; text-align:center;
  font-family:'DM Mono',monospace; font-size:24px; font-weight:500;
  color:var(--text); background:var(--bg); outline:none;
  letter-spacing:8px;
  transition:border-color 0.15s;
}
.pin-input:focus { border-color:var(--accent); background:white; }
.pin-input.err { border-color:var(--red); animation:shake 0.3s ease; }

@keyframes shake {
  0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)}
}

.modal-btns { display:flex; gap:8px; }
.modal-btn {
  flex:1; padding:13px; border-radius:11px; border:none;
  font-family:'Nunito',sans-serif; font-size:14px; font-weight:800;
  cursor:pointer; transition:opacity 0.15s;
}
.modal-btn.cancel { background:var(--surface2); color:var(--text2); }
.modal-btn.confirm { background:var(--accent); color:white; }
.modal-btn.danger  { background:var(--red); color:white; }
.modal-btn:active  { opacity:0.85; }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast {
  position:fixed;
  bottom:calc(var(--nav-h) + 10px);
  left:50%; transform:translateX(-50%) translateY(8px);
  background:rgba(44,40,37,0.92); color:white;
  font-family:'Nunito',sans-serif; font-size:13px; font-weight:700;
  padding:9px 18px; border-radius:99px;
  z-index:1000; opacity:0; transition:all 0.22s;
  white-space:nowrap; pointer-events:none;
}
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="logo">
    <span class="logo-ia">Pul</span>Track
  </div>
  <div class="topbar-right">
    <span id="clock-disp">--:--</span>
  </div>
</div>

<!-- PAGES -->
<div class="pages">

  <!-- DASHBOARD -->
  <div class="page active" id="page-dash">
    <div class="hero-card">
      <div class="hero-label">Jami xarajat</div>
      <div class="hero-amount" id="h-total">0 UZS</div>
      <div class="hero-row">
        <div class="hero-stat">
          <div class="hero-stat-val" id="h-remain">‚Äî</div>
          <div class="hero-stat-lbl">Qoldi</div>
        </div>
        <div class="hero-stat">
          <div class="hero-stat-val" id="h-count">0</div>
          <div class="hero-stat-lbl">Operatsiya</div>
        </div>
      </div>
      <div class="prog-wrap">
        <div class="prog-meta">
          <span id="h-prog-lbl">Byudjet belgilanmagan</span>
          <span id="h-prog-pct"></span>
        </div>
        <div class="prog-track"><div class="prog-fill" id="h-prog-fill" style="width:0%"></div></div>
      </div>
    </div>

    <div class="mini-stats">
      <div class="mini-card">
        <div class="mini-ico ic-oziq">üìÖ</div>
        <div class="mini-val" id="m-today">0</div>
        <div class="mini-lbl">Bugun (UZS)</div>
      </div>
      <div class="mini-card">
        <div class="mini-ico ic-transport">üèÜ</div>
        <div class="mini-val" id="m-topcat">‚Äî</div>
        <div class="mini-lbl">Asosiy kategoriya</div>
      </div>
    </div>

    <div>
      <div class="sec-title">So'nggi xarajatlar</div>
      <div class="hist-list" id="dash-recent"></div>
    </div>
  </div>

  <!-- QO'SHISH -->
  <div class="page" id="page-add">
    <div class="card add-form">
      <div class="sec-title">Yangi xarajat</div>
      <div class="f-row">
        <div class="f-lbl">Tavsif</div>
        <input class="f-input" type="text" id="f-desc" placeholder="Masalan: non va sut" maxlength="60"/>
      </div>
      <div class="f-row">
        <div class="f-lbl">Miqdor</div>
        <div class="amt-wrap">
          <span class="cur">UZS</span>
          <input class="f-input" type="text" id="f-amount" placeholder="0" inputmode="numeric"/>
        </div>
      </div>
      <div class="f-row">
        <div class="f-lbl">Kategoriya</div>
        <div class="cat-grid" id="cat-grid">
          <div class="cat-item sel" data-cat="oziq"><span class="ico">üåæ</span>Oziq-ovqat</div>
          <div class="cat-item" data-cat="transport"><span class="ico">üöå</span>Transport</div>
          <div class="cat-item" data-cat="kommunal"><span class="ico">üí°</span>Kommunal</div>
          <div class="cat-item" data-cat="soglik"><span class="ico">üíä</span>Sog'liq</div>
          <div class="cat-item" data-cat="kiyim"><span class="ico">üëî</span>Kiyim</div>
          <div class="cat-item" data-cat="uy"><span class="ico">üè†</span>Uy-joy</div>
          <div class="cat-item" data-cat="ta ºlim"><span class="ico">üìö</span>Ta'lim</div>
          <div class="cat-item" data-cat="ko ºngil"><span class="ico">üéÆ</span>Ko'ngil</div>
          <div class="cat-item" data-cat="boshqa"><span class="ico">üì¶</span>Boshqa</div>
        </div>
      </div>
      <button class="add-btn" onclick="addEntry()">Qo'shish</button>
    </div>
  </div>

  <!-- TARIX -->
  <div class="page" id="page-hist">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <div class="sec-title" style="margin-bottom:0">Barcha xarajatlar</div>
      <button onclick="openClearConfirm()" style="font-family:'Nunito',sans-serif;font-size:11px;font-weight:800;color:var(--red);background:none;border:none;cursor:pointer;">Tozalash</button>
    </div>
    <div class="filter-row">
      <button class="filter-btn" id="filter-date-btn" onclick="toggleDateFilter()">üìÖ Kun bo'yicha</button>
      <button class="filter-btn" id="filter-cat-btn" onclick="openCatFilter()">üìÇ Kategoriya</button>
    </div>
    <div id="date-filter-section" style="display:none; margin-top:8px;">
      <div style="display:flex; gap:6px; margin-bottom:8px;">
        <input type="date" id="filter-date-start" class="f-input" style="flex:1; padding:8px; font-size:12px;"/>
        <input type="date" id="filter-date-end" class="f-input" style="flex:1; padding:8px; font-size:12px;"/>
      </div>
      <div style="display:flex; gap:6px;">
        <button class="modal-btn cancel" style="flex:1; font-size:12px; padding:8px;" onclick="clearDateFilter()">Tozalash</button>
        <button class="modal-btn confirm" style="flex:1; font-size:12px; padding:8px;" onclick="applyDateFilter()">Qo'llash</button>
      </div>
    </div>
    <div class="hist-list" id="hist-list"></div>
  </div>

  <!-- BOSHQA (settings + budget) -->
  <div class="page" id="page-other">
    <div class="chart-card">
      <div class="chart-title">Oylik diagramma</div>
      <canvas id="monthChart" class="chart-canvas"></canvas>
    </div>

    <div class="card" style="display: none;">
      <div class="sec-title">Byudjet sozlash</div>
      <div style="display:flex;gap:8px;align-items:center;">
        <div style="flex:1;">
          <div style="font-size:11px;color:var(--text3);font-weight:700;margin-bottom:4px;">
            Oylik byudjet: <span style="color:var(--accent);font-family:'DM Mono',monospace;font-size:16px;" id="budget-display">‚Äî</span> UZS
          </div>
        </div>
        <button class="setting-action" onclick="openBudgetChange()">O'zgartirish</button>
      </div>
    </div>

    <div class="settings-list">
      <div class="sec-title">Sozlamalar</div>
      <div class="setting-item">
        <div class="setting-info">
          <div class="setting-name" onclick="openBudgetChange()">Byudjet sozlash</div>
          <div class="setting-desc" onclick="openBudgetChange()">Oylik daromadingizni kiriting</div>
        </div>
        <button class="setting-action" onclick="openBudgetChange()" style="display: none;">O'zgartirish</button>
      </div>
      <div class="setting-item">
        <div class="setting-info">
          <div class="setting-name">Bildirishnomalar</div>
          <div class="setting-desc">Byudjet tugaganda ogohlantir</div>
        </div>
        <button class="setting-action disabled">Tez orada</button>
      </div>
      <div class="setting-item">
        <div class="setting-info">
          <div class="setting-name">Davr</div>
          <div class="setting-desc">Haftalik/Oylik/Yillik</div>
        </div>
        <button class="setting-action disabled">Tez orada</button>
      </div>
      <div class="setting-item">
        <div class="setting-info">
          <div class="setting-name">Export</div>
          <div class="setting-desc">Ma'lumotlarni yuklab olish</div>
        </div>
        <button class="setting-action disabled">Tez orada</button>
      </div>
    </div>
  </div>

</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-btn active" onclick="goPage('dash',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>
    Dashboard
  </button>
  <button class="nav-btn" onclick="goPage('add',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="9"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
    Qo'shish
  </button>
  <button class="nav-btn" onclick="goPage('hist',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
    Tarix
  </button>
  <button class="nav-btn" onclick="goPage('other',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M4.22 4.22l4.24 4.24m5.66 5.66l4.24 4.24M1 12h6m6 0h6M4.22 19.78l4.24-4.24m5.66-5.66l4.24-4.24"/></svg>
    Boshqa
  </button>
</nav>

<!-- MODAL: PIN for budget change -->
<div class="modal-backdrop" id="modal-budget-pin">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Tasdiqlash</div>
    <div class="modal-sub">Oylik byudjetni tahrirlash uchun maxfiy raqamni kiriting.</div>
    <div class="pin-hint" style="display: none;">Hozirgi kod: <span id="budget-pin-show">----</span></div>
    <input class="pin-input" type="text" id="budget-pin-input" maxlength="4" placeholder="¬∑¬∑¬∑¬∑" inputmode="numeric" autocomplete="off"/>
    <div class="modal-btns">
      <button class="modal-btn cancel" onclick="closeModal('modal-budget-pin')">Bekor</button>
      <button class="modal-btn confirm" onclick="confirmBudgetPin()">Tasdiqlash</button>
    </div>
  </div>
</div>

<!-- MODAL: Budget amount input -->
<div class="modal-backdrop" id="modal-budget-amount">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Byudjet kiritish</div>
    <div class="modal-sub">Oylik byudjet miqdorini kiriting</div>
    <div class="f-row">
      <div class="f-lbl">Miqdor (UZS)</div>
      <input class="f-input" type="number" id="new-budget-input" placeholder="1000000" inputmode="numeric"/>
    </div>
    <div class="modal-btns">
      <button class="modal-btn cancel" onclick="closeModal('modal-budget-amount')">Bekor</button>
      <button class="modal-btn confirm" onclick="saveBudgetAmount()">Saqlash</button>
    </div>
  </div>
</div>

<!-- MODAL: Edit Entry -->
<div class="modal-backdrop" id="modal-edit">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Xarajatni tahrirlash</div>
    <div class="f-row">
      <div class="f-lbl">Miqdor</div>
      <div class="amt-wrap">
        <span class="cur">UZS</span>
        <input class="f-input" type="text" id="edit-amount" placeholder="0" inputmode="numeric"/>
      </div>
    </div>
    <div class="f-row">
      <div class="f-lbl">Kategoriya</div>
      <div class="cat-grid" id="edit-cat-grid">
        <!-- populated dynamically -->
      </div>
    </div>
    <div class="modal-btns">
      <button class="modal-btn cancel" onclick="closeModal('modal-edit')">Bekor</button>
      <button class="modal-btn confirm" onclick="saveEdit()">Saqlash</button>
    </div>
  </div>
</div>

<!-- MODAL: Delete confirm -->
<div class="modal-backdrop" id="modal-del">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">O'chirishni tasdiqlang</div>
    <div class="modal-sub" id="modal-del-desc">Bu xarajatni o'chirmoqchimisiz?</div>
    <div class="modal-btns">
      <button class="modal-btn cancel" onclick="closeModal('modal-del')">Bekor</button>
      <button class="modal-btn danger" onclick="confirmDelete()">O'chirish</button>
    </div>
  </div>
</div>

<!-- MODAL: Clear all -->
<div class="modal-backdrop" id="modal-clear">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Hammasini o'chirish</div>
    <div class="modal-sub">Barcha xarajatlarni o'chirmoqchimisiz?</div>
    <div class="modal-btns">
      <button class="modal-btn cancel" onclick="closeModal('modal-clear')">Bekor</button>
      <button class="modal-btn danger" onclick="confirmClear()">Hammani o'chirish</button>
    </div>
  </div>
</div>

<!-- MODAL: Category filter -->
<div class="modal-backdrop" id="modal-cat-filter">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Kategoriya tanlang</div>
    <div class="cat-grid" id="filter-cat-grid">
      <!-- populated dynamically -->
    </div>
    <div class="modal-btns">
      <button class="modal-btn cancel" onclick="clearCatFilter()">Tozalash</button>
      <button class="modal-btn confirm" onclick="closeModal('modal-cat-filter')">Yopish</button>
    </div>
  </div>
</div>

<!-- MODAL: Month reset confirmation -->
<div class="modal-backdrop" id="modal-month-reset">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Diagramma yangilash</div>
    <div class="modal-sub">Yangi oy boshlandi. Diagrammani yangilashni xohlaysizmi? Bu harakat o'tgan oy ma'lumotlarini arxivlaydi.</div>
    <div class="modal-btns">
      <button class="modal-btn cancel" onclick="skipMonthReset()">Keyinroq</button>
      <button class="modal-btn confirm" onclick="confirmMonthReset()">Yangilash</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const CATS = {
  oziq:      { label:'Oziq-ovqat', ico:'üåæ', ic:'ic-oziq',      bar:'bar-oziq'      },
  transport: { label:'Transport',  ico:'üöå', ic:'ic-transport', bar:'bar-transport' },
  kommunal:  { label:'Kommunal',   ico:'üí°', ic:'ic-kommunal',  bar:'bar-kommunal'  },
  soglik:    { label:"Sog'liq",    ico:'üíä', ic:'ic-soglik',    bar:'bar-soglik'    },
  kiyim:     { label:'Kiyim',      ico:'üëî', ic:'ic-kiyim',     bar:'bar-kiyim'     },
  uy:        { label:'Uy-joy',     ico:'üè†', ic:'ic-uy',        bar:'bar-uy'        },
  ta ºlim:    { label:"Ta'lim",     ico:'üìö', ic:'ic-ta ºlim',    bar:'bar-ta ºlim'    },
  ko ºngil:   { label:"Ko'ngil",    ico:'üéÆ', ic:'ic-ko ºngil',   bar:'bar-ko ºngil'   },
  boshqa:    { label:'Boshqa',     ico:'üì¶', ic:'ic-boshqa',    bar:'bar-boshqa'    },
};

let entries = [];
let budget  = 0;
let selCat  = 'oziq';
let editingId = null;
let pendingDeleteId = null;
let editCat = 'oziq';
let filterDateStart = null;
let filterDateEnd = null;
let filterCats = new Set();
let chartResetMonth = null; // tracks when chart was last reset

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmt(n) {
  if (n >= 1000000) return (n/1000000).toFixed(1).replace('.0','') + 'M';
  if (n >= 1000)    return Math.round(n/1000) + 'K';
  return Math.round(n).toString();
}
function fmtFull(n) { return Math.round(n).toLocaleString('uz-UZ'); }
function today()    { return new Date().toISOString().slice(0,10); }

function dateLabel(iso) {
  if (iso === today()) return 'Bugun';
  const y = new Date(); y.setDate(y.getDate()-1);
  if (iso === y.toISOString().slice(0,10)) return 'Kecha';
  return new Date(iso).toLocaleDateString('uz-UZ', {day:'numeric', month:'short'});
}

// Format number with spaces: 1000000 ‚Üí 1 000 000
function formatInputNumber(val) {
  return val.replace(/\D/g,'').replace(/\B(?=(\d{3})+(?!\d))/g,' ');
}

// ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveLocal() {
  localStorage.setItem('x_entries4', JSON.stringify(entries));
  localStorage.setItem('x_budget4',  budget);
}

function loadLocal() {
  entries = JSON.parse(localStorage.getItem('x_entries4') || '[]');
  budget  = parseFloat(localStorage.getItem('x_budget4')  || '0');
  chartResetMonth = localStorage.getItem('x_chart_reset') || null;
  renderDash();
  renderChart();
  checkMonthReset();
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function goPage(name, btn) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  btn.classList.add('active');
  if (name==='dash')  renderDash();
  if (name==='hist')  renderHist();
  if (name==='other') { renderChart(); updateBudgetDisplay(); }
}

// ‚îÄ‚îÄ CAT SELECT (add page) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('#cat-grid .cat-item').forEach(el => {
  el.addEventListener('click', () => {
    document.querySelectorAll('#cat-grid .cat-item').forEach(x=>x.classList.remove('sel'));
    el.classList.add('sel');
    selCat = el.dataset.cat;
  });
});

// Amount input formatting
const amtInput = document.getElementById('f-amount');
amtInput.addEventListener('input', e => {
  e.target.value = formatInputNumber(e.target.value);
});

// ‚îÄ‚îÄ ADD ENTRY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addEntry() {
  const desc   = document.getElementById('f-desc').value.trim();
  const amtStr = document.getElementById('f-amount').value.replace(/\s/g,'');
  const amount = parseFloat(amtStr);
  if (!desc)               { toast('Tavsif kiriting'); return; }
  if (!amount || amount<=0){ toast("To'g'ri miqdor kiriting"); return; }

  entries.unshift({ id: Date.now(), desc, amount, cat: selCat, date: today() });
  saveLocal();
  document.getElementById('f-desc').value   = '';
  document.getElementById('f-amount').value = '';
  renderDash();
  toast("‚úì Xarajat qo'shildi");

  const total = entries.reduce((s,e)=>s+e.amount,0);
  if (budget && total > budget) setTimeout(()=>toast('‚ö† Byudjet oshib ketdi!'),2400);
}

// ‚îÄ‚îÄ BUDGET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getTimePin() {
  const n = new Date();
  const h = String(n.getHours()).padStart(2,'0');
  const m = String(n.getMinutes()).padStart(2,'0');
  return h + m;
}

function openBudgetChange() {
  document.getElementById('budget-pin-show').textContent = getTimePin();
  document.getElementById('budget-pin-input').value = '';
  document.getElementById('budget-pin-input').classList.remove('err');
  openModal('modal-budget-pin');
  setTimeout(()=>document.getElementById('budget-pin-input').focus(), 300);
}

function confirmBudgetPin() {
  const entered = document.getElementById('budget-pin-input').value.trim();
  const correct = getTimePin();
  if (entered !== correct) {
    const inp = document.getElementById('budget-pin-input');
    inp.classList.add('err');
    setTimeout(()=>inp.classList.remove('err'), 400);
    toast("Noto'g'ri kod");
    return;
  }
  closeModal('modal-budget-pin');
  document.getElementById('new-budget-input').value = budget || '';
  openModal('modal-budget-amount');
  setTimeout(()=>document.getElementById('new-budget-input').focus(), 300);
}

function saveBudgetAmount() {
  const val = parseFloat(document.getElementById('new-budget-input').value);
  if (!val || val<=0) { toast("To'g'ri miqdor kiriting"); return; }
  budget = val;
  saveLocal();
  closeModal('modal-budget-amount');
  toast('‚úì Byudjet saqlandi');
  updateBudgetDisplay();
  renderDash();
}

function updateBudgetDisplay() {
  const el = document.getElementById('budget-display');
  el.textContent = budget ? fmtFull(budget) : '‚Äî';
}

// ‚îÄ‚îÄ EDIT / DELETE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let longPressTimer;
let activeContextId = null;

function handleEntryClick(id, event) {
  // Desktop: single click toggles context
  if (!('ontouchstart' in window)) {
    event.stopPropagation();
    if (activeContextId === id) {
      hideAllContexts();
    } else {
      showContext(id);
    }
  }
}

function handleTouchStart(id) {
  // Mobile: long press (500ms)
  longPressTimer = setTimeout(() => showContext(id), 500);
}

function handleTouchEnd() {
  clearTimeout(longPressTimer);
}

function showContext(id) {
  hideAllContexts();
  activeContextId = id;
  const card = document.querySelector(`[data-entry-id="${id}"]`);
  if (!card) return;
  const ctx = document.createElement('div');
  ctx.className = 'entry-context';
  ctx.id = 'ctx-' + id;
  ctx.innerHTML = `
    <button class="entry-context-btn edit" onclick="openEditModal(${id})">Tahrirlash</button>
    <button class="entry-context-btn delete" onclick="openDeleteConfirm(${id})">O'chirish</button>
  `;
  card.appendChild(ctx);
}

function hideAllContexts() {
  document.querySelectorAll('.entry-context').forEach(el=>el.remove());
  activeContextId = null;
}

function openEditModal(id) {
  hideAllContexts();
  editingId = id;
  const e = entries.find(x=>x.id===id);
  if (!e) return;
  document.getElementById('edit-amount').value = formatInputNumber(String(e.amount));
  editCat = e.cat;
  
  // populate cat grid
  const grid = document.getElementById('edit-cat-grid');
  grid.innerHTML = Object.entries(CATS).map(([key, c]) => 
    `<div class="cat-item ${key===editCat?'sel':''}" data-cat="${key}" onclick="selectEditCat('${key}')">
      <span class="ico">${c.ico}</span>${c.label}
    </div>`
  ).join('');
  
  openModal('modal-edit');
  setTimeout(()=>document.getElementById('edit-amount').focus(), 300);
}

function selectEditCat(cat) {
  editCat = cat;
  document.querySelectorAll('#edit-cat-grid .cat-item').forEach(x=>x.classList.remove('sel'));
  document.querySelector(`#edit-cat-grid [data-cat="${cat}"]`).classList.add('sel');
}

const editAmtInput = document.getElementById('edit-amount');
editAmtInput.addEventListener('input', e => {
  e.target.value = formatInputNumber(e.target.value);
});

function saveEdit() {
  if (editingId === null) return;
  const amtStr = document.getElementById('edit-amount').value.replace(/\s/g,'');
  const amount = parseFloat(amtStr);
  if (!amount || amount<=0) { toast("To'g'ri miqdor kiriting"); return; }
  
  const e = entries.find(x=>x.id===editingId);
  if (!e) return;
  e.amount = amount;
  e.cat = editCat;
  saveLocal();
  closeModal('modal-edit');
  renderDash();
  renderHist();
  toast('‚úì Tahrirlandi');
  editingId = null;
}

function openDeleteConfirm(id) {
  hideAllContexts();
  pendingDeleteId = id;
  const e = entries.find(x=>x.id===id);
  document.getElementById('modal-del-desc').textContent =
    e ? `"${e.desc}" ‚Äî ${fmtFull(e.amount)} UZS ni o'chirmoqchimisiz?`
      : "Bu xarajatni o'chirmoqchimisiz?";
  openModal('modal-del');
}

function confirmDelete() {
  if (pendingDeleteId === null) return;
  const id = pendingDeleteId;
  pendingDeleteId = null;
  closeModal('modal-del');
  entries = entries.filter(e=>e.id!==id);
  saveLocal();
  renderDash(); renderHist();
  toast("O'chirildi");
}

function openClearConfirm() {
  if (!entries.length) { toast("Jurnal bo'sh"); return; }
  openModal('modal-clear');
}

function confirmClear() {
  closeModal('modal-clear');
  entries = [];
  saveLocal();
  renderDash(); renderHist();
  toast('Tozalandi');
}

// ‚îÄ‚îÄ MODAL HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

document.querySelectorAll('.modal-backdrop').forEach(el => {
  el.addEventListener('click', e => { if (e.target===el) closeModal(el.id); });
});

document.getElementById('budget-pin-input').addEventListener('keydown', e => {
  if (e.key==='Enter') confirmBudgetPin();
});

// ‚îÄ‚îÄ ENTRY HTML ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function entryHTML(e, allowContext = false) {
  const c = CATS[e.cat]||CATS.boshqa;
  const contextAttr = allowContext ? `data-entry-id="${e.id}" class="entry-card clickable"` : 'class="entry-card"';
  
  // Desktop: click to show context
  // Mobile: long press
  const contextEvent = allowContext 
    ? `onclick="handleEntryClick(${e.id}, event)" ontouchstart="handleTouchStart(${e.id})" ontouchend="handleTouchEnd()" ontouchcancel="handleTouchEnd()"`
    : '';
  
  return `<div ${contextAttr} ${contextEvent}>
    <div class="entry-ico ${c.ic}">${c.ico}</div>
    <div class="entry-info">
      <div class="entry-desc">${e.desc}</div>
      <div class="entry-meta">${dateLabel(e.date)} ¬∑ ${c.label}</div>
    </div>
    <div class="entry-right">
      <div class="entry-amt">${fmtFull(e.amount)}</div>
    </div>
  </div>`;
}

// ‚îÄ‚îÄ RENDER DASH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDash() {
  const total = entries.reduce((s,e)=>s+e.amount,0);
  document.getElementById('h-total').textContent = fmtFull(total)+' UZS';
  document.getElementById('h-count').textContent = entries.length;

  if (budget) {
    const rem = budget - total;
    document.getElementById('h-remain').textContent = fmt(Math.abs(rem))+(rem<0?' ‚Üë':'')+' UZS';
    const pct = Math.min(total/budget*100, 100);
    document.getElementById('h-prog-fill').style.width = pct+'%';
    document.getElementById('h-prog-lbl').textContent  = 'Byudjet: '+fmt(budget)+' UZS';
    document.getElementById('h-prog-pct').textContent  = Math.round(pct)+'%';
  } else {
    document.getElementById('h-remain').textContent    = '‚Äî';
    document.getElementById('h-prog-lbl').textContent  = 'Byudjet belgilanmagan';
    document.getElementById('h-prog-pct').textContent  = '';
    document.getElementById('h-prog-fill').style.width = '0%';
  }

  const todayT = entries.filter(e=>e.date===today()).reduce((s,e)=>s+e.amount,0);
  document.getElementById('m-today').textContent = fmt(todayT);

  const catT={};
  entries.forEach(e=>{ catT[e.cat]=(catT[e.cat]||0)+e.amount; });
  const top = Object.entries(catT).sort((a,b)=>b[1]-a[1])[0];
  document.getElementById('m-topcat').textContent = top ? CATS[top[0]].ico : '‚Äî';

  const el  = document.getElementById('dash-recent');
  const rec = entries.slice(0,3);
  el.innerHTML = rec.length
    ? rec.map(e=>entryHTML(e, false)).join('')
    : '<div class="empty-msg"><div class="big">üå±</div>Hali xarajat yo\'q</div>';
}

// ‚îÄ‚îÄ RENDER HIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHist() {
  let filtered = [...entries];
  
  // Apply date filter
  if (filterDateStart || filterDateEnd) {
    filtered = filtered.filter(e => {
      if (filterDateStart && e.date < filterDateStart) return false;
      if (filterDateEnd && e.date > filterDateEnd) return false;
      return true;
    });
  }
  
  // Apply category filter
  if (filterCats.size > 0) {
    filtered = filtered.filter(e => filterCats.has(e.cat));
  }
  
  const el = document.getElementById('hist-list');
  el.innerHTML = filtered.length
    ? filtered.map(e=>entryHTML(e, true)).join('')
    : '<div class="empty-msg"><div class="big">üìã</div>Hali xarajat yo\'q</div>';
}

// ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleDateFilter() {
  const section = document.getElementById('date-filter-section');
  const btn = document.getElementById('filter-date-btn');
  const isOpen = section.style.display === 'block';
  section.style.display = isOpen ? 'none' : 'block';
  btn.classList.toggle('active', !isOpen);
}

function applyDateFilter() {
  filterDateStart = document.getElementById('filter-date-start').value || null;
  filterDateEnd = document.getElementById('filter-date-end').value || null;
  renderHist();
  const btn = document.getElementById('filter-date-btn');
  btn.classList.toggle('active', filterDateStart || filterDateEnd);
}

function clearDateFilter() {
  filterDateStart = null;
  filterDateEnd = null;
  document.getElementById('filter-date-start').value = '';
  document.getElementById('filter-date-end').value = '';
  document.getElementById('date-filter-section').style.display = 'none';
  document.getElementById('filter-date-btn').classList.remove('active');
  renderHist();
}

function openCatFilter() {
  const grid = document.getElementById('filter-cat-grid');
  grid.innerHTML = Object.entries(CATS).map(([key, c]) => 
    `<div class="cat-item ${filterCats.has(key)?'sel':''}" data-cat="${key}" onclick="toggleFilterCat('${key}')">
      <span class="ico">${c.ico}</span>${c.label}
    </div>`
  ).join('');
  openModal('modal-cat-filter');
}

function toggleFilterCat(cat) {
  if (filterCats.has(cat)) {
    filterCats.delete(cat);
  } else {
    filterCats.add(cat);
  }
  const el = document.querySelector(`#filter-cat-grid [data-cat="${cat}"]`);
  el.classList.toggle('sel');
  renderHist();
  const btn = document.getElementById('filter-cat-btn');
  btn.classList.toggle('active', filterCats.size > 0);
}

function clearCatFilter() {
  filterCats.clear();
  const grid = document.getElementById('filter-cat-grid');
  grid.querySelectorAll('.cat-item').forEach(el => el.classList.remove('sel'));
  renderHist();
  document.getElementById('filter-cat-btn').classList.remove('active');
  closeModal('modal-cat-filter');
}

// ‚îÄ‚îÄ RENDER CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderChart() {
  const canvas = document.getElementById('monthChart');
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth * 2;
  canvas.height = canvas.offsetHeight * 2;
  ctx.scale(2, 2);
  
  const w = canvas.offsetWidth;
  const h = canvas.offsetHeight;
  
  ctx.clearRect(0, 0, w, h);
  
  if (entries.length === 0) {
    ctx.fillStyle = '#ADA89F';
    ctx.font = '12px Nunito';
    ctx.textAlign = 'center';
    ctx.fillText('Hali xarajat yo\'q', w/2, h/2);
    return;
  }
  
  // Get current month entries only
  const today = new Date();
  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();
  
  const monthEntries = entries.filter(e => {
    const d = new Date(e.date);
    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
  });
  
  if (monthEntries.length === 0) {
    ctx.fillStyle = '#ADA89F';
    ctx.font = '12px Nunito';
    ctx.textAlign = 'center';
    ctx.fillText('Bu oyda hali xarajat yo\'q', w/2, h/2);
    return;
  }
  
  // Find first entry date in this month
  const dates = monthEntries.map(e => new Date(e.date));
  const firstDate = new Date(Math.min(...dates));
  const firstDay = firstDate.getDate();
  const todayDay = today.getDate();
  
  // Calculate days to show (from first entry to today)
  const daysToShow = todayDay - firstDay + 1;
  
  if (daysToShow <= 0) {
    ctx.fillStyle = '#ADA89F';
    ctx.font = '12px Nunito';
    ctx.textAlign = 'center';
    ctx.fillText('Ma\'lumot yo\'q', w/2, h/2);
    return;
  }
  
  // Build daily data
  const dailyData = [];
  for (let i = 0; i < daysToShow; i++) {
    const day = firstDay + i;
    const d = new Date(currentYear, currentMonth, day);
    const dateStr = d.toISOString().slice(0,10);
    const dayTotal = monthEntries.filter(e => e.date === dateStr).reduce((s,e)=>s+e.amount, 0);
    dailyData.push({ day: day, total: dayTotal });
  }
  
  const maxTotal = Math.max(...dailyData.map(d=>d.total), 1);
  const barW = (w - 40) / daysToShow;
  const chartH = h - 40;
  
  dailyData.forEach((d, i) => {
    const barH = (d.total / maxTotal) * chartH;
    const x = 20 + i * barW;
    const y = h - 20 - barH;
    
    ctx.fillStyle = '#4A7C59';
    ctx.fillRect(x, y, Math.max(barW - 4, 2), barH);
    
    // Day label (show every 3rd day if too many)
    if (daysToShow <= 10 || i % 3 === 0) {
      ctx.fillStyle = '#7C776F';
      ctx.font = '10px Nunito';
      ctx.textAlign = 'center';
      ctx.fillText(d.day, x + barW/2 - 2, h - 5);
    }
  });
}

// ‚îÄ‚îÄ MONTH RESET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkMonthReset() {
  const today = new Date();
  const currentMonthKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
  
  // If it's the 1st of the month and we haven't reset yet
  if (today.getDate() === 1 && chartResetMonth !== currentMonthKey) {
    openModal('modal-month-reset');
  }
}

function confirmMonthReset() {
  const today = new Date();
  const currentMonthKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
  
  chartResetMonth = currentMonthKey;
  localStorage.setItem('x_chart_reset', chartResetMonth);
  
  closeModal('modal-month-reset');
  renderChart();
  toast('‚úì Diagramma yangilandi');
}

function skipMonthReset() {
  closeModal('modal-month-reset');
  toast('Keyinroq yangilashingiz mumkin');
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let toastT;
function toast(msg) {
  const el=document.getElementById('toast');
  el.textContent=msg;
  el.classList.add('show');
  clearTimeout(toastT);
  toastT=setTimeout(()=>el.classList.remove('show'),2000);
}

// ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tick() {
  const n=new Date();
  const t=String(n.getHours()).padStart(2,'0')+':'+String(n.getMinutes()).padStart(2,'0');
  document.getElementById('clock-disp').textContent=t;
  if (document.getElementById('modal-budget-pin').classList.contains('open')) {
    document.getElementById('budget-pin-show').textContent = getTimePin();
  }
}
tick();
setInterval(tick, 10000);

// ‚îÄ‚îÄ ENTER KEY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e=>{
  if (e.key==='Enter' && ['f-desc','f-amount'].includes(document.activeElement.id)) addEntry();
});

// Hide context menu when clicking outside
document.addEventListener('click', e => {
  if (!e.target.closest('.entry-context') && !e.target.closest('.entry-card')) {
    hideAllContexts();
  }
});

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
loadLocal();
updateBudgetDisplay();
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').catch(console.warn);
    });
  }
</script>
</body>
</html>
