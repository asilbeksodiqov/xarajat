<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8"/>
<meta name="theme-color" content="#4A7C59"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="hisobIA"/>
<link rel="apple-touch-icon" href="/icons/icon-192.png"/>
<link rel="manifest" href="/manifest.json"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<title>FinTrack</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap');

:root {
  --bg:       #F5F2EE;
  --surface:  #FFFFFF;
  --surface2: #EDE9E3;
  --border:   #DDD8CF;
  --text:     #2C2825;
  --text2:    #7C776F;
  --text3:    #ADA89F;
  --accent:   #4A7C59;
  --accent-l: #E8F2EC;
  --red:      #C0392B;
  --nav-h:    64px;
  --top-h:    56px;
  --radius:   16px;
  --shadow:   0 2px 12px rgba(44,40,37,0.08);
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

html, body { height:100%; overflow:hidden; }

body {
  font-family: 'Nunito', sans-serif;
  background: var(--bg);
  color: var(--text);
  max-width: 430px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
}

/* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
.topbar {
  height: var(--top-h);
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 18px;
  justify-content: space-between;
  flex-shrink: 0;
  z-index: 10;
}

/* ‚îÄ‚îÄ LOGO ‚îÄ‚îÄ */
.logo {
  font-size: 19px;
  font-weight: 800;
  letter-spacing: -0.5px;
  color: var(--text);
  display: flex;
  align-items: baseline;
  gap: 0;
  user-select: none;
}

.logo-ia{
  color: var(--accent);
  display: inline;
  position: static;
  width: auto;
  height: auto;
}

.topbar-right { display:flex; align-items:center; gap:8px; }

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.pages { flex:1; overflow:hidden; position:relative; }

.page {
  position: absolute; inset: 0;
  overflow-y: auto;
  padding: 14px 14px 10px;
  display: none;
  flex-direction: column;
  gap: 11px;
}
.page.active { display:flex; }

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.bottom-nav {
  height: var(--nav-h);
  background: var(--surface);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: stretch;
  flex-shrink: 0;
  z-index: 10;
}

.nav-btn {
  flex: 1;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 3px;
  background: none; border: none;
  cursor: pointer;
  font-family: 'Nunito', sans-serif;
  font-size: 10px; font-weight: 700;
  color: var(--text3);
  transition: color 0.18s;
  position: relative;
}
.nav-btn svg { width:21px; height:21px; stroke-width:1.8; }
.nav-btn.active { color: var(--accent); }
.nav-btn.active::before {
  content:'';
  position:absolute; top:0; left:25%; right:25%;
  height:2.5px; background:var(--accent);
  border-radius:0 0 3px 3px;
}

/* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
.card { background:var(--surface); border-radius:var(--radius); padding:15px; box-shadow:var(--shadow); }

/* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
.hero-card {
  background: var(--accent); color:white;
  border-radius: var(--radius);
  padding: 18px 16px 16px;
  position: relative; overflow: hidden;
}
.hero-card::before {
  content:''; position:absolute; top:-25px; right:-25px;
  width:110px; height:110px;
  background:rgba(255,255,255,0.07); border-radius:50%;
}
.hero-card::after {
  content:''; position:absolute; bottom:-35px; right:15px;
  width:80px; height:80px;
  background:rgba(255,255,255,0.05); border-radius:50%;
}
.hero-label { font-size:10px; font-weight:700; opacity:0.7; letter-spacing:1.2px; text-transform:uppercase; }
.hero-amount {
  font-family:'DM Mono',monospace; font-size:32px; font-weight:500;
  margin:4px 0 12px; letter-spacing:-1px; line-height:1;
}
.hero-row { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.hero-stat { background:rgba(255,255,255,0.13); border-radius:10px; padding:9px 11px; }
.hero-stat-val { font-family:'DM Mono',monospace; font-size:16px; font-weight:500; line-height:1; }
.hero-stat-lbl { font-size:10px; opacity:0.65; margin-top:3px; }

.prog-wrap { margin-top:10px; }
.prog-meta { display:flex; justify-content:space-between; font-size:10px; opacity:0.7; margin-bottom:4px; }
.prog-track { background:rgba(255,255,255,0.2); border-radius:99px; height:5px; overflow:hidden; }
.prog-fill { height:100%; border-radius:99px; background:white; transition:width 0.5s ease; }

/* ‚îÄ‚îÄ MINI STATS ‚îÄ‚îÄ */
.mini-stats { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.mini-card { background:var(--surface); border-radius:14px; padding:13px; box-shadow:var(--shadow); }
.mini-ico { width:30px; height:30px; border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:15px; margin-bottom:7px; }
.mini-val { font-family:'DM Mono',monospace; font-size:16px; color:var(--text); line-height:1; font-weight:500; }
.mini-lbl { font-size:10px; color:var(--text3); margin-top:3px; font-weight:700; letter-spacing:0.4px; }

/* ‚îÄ‚îÄ SEC TITLE ‚îÄ‚îÄ */
.sec-title { font-size:10px; font-weight:800; letter-spacing:1.2px; color:var(--text3); text-transform:uppercase; margin-bottom:8px; }

/* ‚îÄ‚îÄ TOGGLE SWITCH ‚îÄ‚îÄ */
.toggle-wrapper {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0;
  margin-bottom: 12px;
  background: #F5F2EE;
  border-radius: 12px;
  padding: 4px;
  width: fit-content;
  margin-left: auto;
  margin-right: auto;
}
.toggle-label {
  font-size: 14px;
  font-weight: 700;
  color: #7C8499;
  text-align: center;
  padding: 10px 24px;
  width: 150px;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s;
  user-select: none;
}
.toggle-label.active { 
  color: white; 
  background: #EF5A6F;
}
.toggle-label.active.income-active {
  background: var(--accent);
}

/* ‚îÄ‚îÄ PROGRESS BAR (Boshqa page) ‚îÄ‚îÄ */
.balance-prog-card {
  background: var(--surface);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow);
}
.balance-prog-title {
  font-size: 11px;
  font-weight: 800;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 12px;
}
.balance-prog-bar-wrap {
  position: relative;
  height: 32px;
  background: var(--accent);
  border-radius: 8px;
  overflow: hidden;
}
.balance-prog-expense {
  position: absolute;
  right: 0;
  top: 0;
  height: 100%;
  background: var(--red);
  transition: width 0.5s ease;
}
.balance-prog-labels {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
}
.balance-prog-label {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.balance-prog-label-name {
  font-size: 10px;
  font-weight: 700;
  color: var(--text3);
  text-transform: uppercase;
}
.balance-prog-label-val {
  font-family: 'DM Mono', monospace;
  font-size: 15px;
  font-weight: 600;
  color: var(--text);
}

/* ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ */
.hist-list { display:flex; flex-direction:column; gap:7px; position:relative; }
.entry-card {
  background:var(--surface); border-radius:13px; padding:12px 13px;
  display:flex; align-items:center; gap:11px;
  box-shadow:0 1px 5px rgba(44,40,37,0.06);
  position:relative;
}
.entry-card.clickable { cursor:pointer; }
.entry-card.income { border-left: 3px solid var(--accent); }
.entry-card.expense { border-left: 3px solid var(--red); }

.entry-ico { width:38px; height:38px; border-radius:11px; display:flex; align-items:center; justify-content:center; font-size:17px; flex-shrink:0; }
.entry-info { flex:1; min-width:0; }
.entry-desc { font-size:13px; font-weight:700; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.entry-meta { font-size:10px; color:var(--text3); margin-top:2px; font-weight:600; }
.entry-right { display:flex; flex-direction:column; align-items:flex-end; gap:5px; flex-shrink:0; }
.entry-amt { font-family:'DM Mono',monospace; font-size:14px; color:var(--text); }
.entry-amt.income { color: var(--accent); }
.entry-amt.expense { color: var(--red); }

/* entry context menu */
.entry-context {
  position:absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: -8px;
  background:var(--surface);
  border:1.5px solid var(--border);
  border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,0.15);
  display:flex;
  gap:4px;
  padding:4px;
  z-index:6;
}
.entry-context-btn {
  background:var(--bg);
  border:none;
  padding:8px 16px;
  border-radius:8px;
  font-size:12px;
  font-weight:800;
  cursor:pointer;
  transition:all 0.15s;
}
.entry-context-btn.edit { color:var(--accent); }
.entry-context-btn.delete { color:var(--red); }
.entry-context-btn:hover { opacity:0.7; }

/* filter buttons */
.filter-row {
  display:flex;
  gap:6px;
  margin-top:6px;
}
.filter-btn {
  flex:1;
  background:var(--surface);
  border:1.5px solid var(--border);
  border-radius:10px;
  padding:10px;
  font-size:11px;
  font-weight:800;
  color:var(--text2);
  cursor:pointer;
  transition:all 0.15s;
}
.filter-btn.active {
  border-color:var(--accent);
  background:var(--accent-l);
  color:var(--accent);
}

.filter-type-row {
  display: flex;
  gap: 6px;
  margin-bottom: 8px;
}
.filter-type-btn {
  flex: 1;
  background: var(--bg);
  border: 1.5px solid var(--border);
  border-radius: 10px;
  padding: 8px;
  font-size: 12px;
  font-weight: 800;
  color: var(--text2);
  cursor: pointer;
  transition: all 0.15s;
}
/* Sarlavhalar grid ichida butun qatorni egallashi uchun */
#filter-cat-grid div:not(.cat-item) {
    grid-column: span 3;
    font-size: 11px;
    font-weight: 800;
    color: var(--text3);
    text-transform: uppercase;
    margin-top: 10px;
    margin-bottom: 5px;
}
.filter-type-btn.sel {
  border-color: var(--accent);
  background: var(--accent-l);
  color: var(--accent);
}

.empty-msg { text-align:center; padding:24px 16px; color:var(--text3); font-size:13px; font-weight:600; }
.empty-msg .big { font-size:28px; margin-bottom:6px; }

/* ‚îÄ‚îÄ ADD FORM ‚îÄ‚îÄ */
.add-form { display:flex; flex-direction:column; gap:10px; }
.f-row { display:flex; flex-direction:column; gap:5px; }
.f-lbl { font-size:10px; font-weight:800; color:var(--text3); letter-spacing:0.8px; text-transform:uppercase; }
.f-input {
  width:100%; border:1.5px solid var(--border); border-radius:11px;
  padding:11px 13px;
  font-family:'Nunito',sans-serif; font-size:15px; font-weight:700;
  color:var(--text); background:var(--bg); outline:none;
  transition:border-color 0.15s, background 0.15s;
}
.f-input:focus { border-color:var(--accent); background:white; }
.amt-wrap { position:relative; }
.amt-wrap .cur { position:absolute; left:13px; top:50%; transform:translateY(-50%); color:var(--text3); font-size:12px; font-weight:800; pointer-events:none; letter-spacing:0.5px; }
.amt-wrap .f-input { padding-left:44px; font-family:'DM Mono',monospace; font-size:19px; }

.cat-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; }
.cat-item {
  display:flex; flex-direction:column; align-items:center; gap:3px;
  padding:9px 4px; border-radius:11px;
  border:1.5px solid var(--border); background:var(--bg);
  cursor:pointer; font-size:10px; font-weight:800; color:var(--text2);
  transition:all 0.15s; text-align:center;
}
.cat-item .ico { font-size:19px; line-height:1; }
.cat-item.sel { border-color:var(--accent); background:var(--accent-l); color:var(--accent); }

.add-btn {
  background:var(--accent); color:white; border:none;
  border-radius:12px; padding:14px;
  font-family:'Nunito',sans-serif; font-size:15px; font-weight:800;
  cursor:pointer; transition:opacity 0.15s, transform 0.1s;
}
.add-btn:active { transform:scale(0.98); opacity:0.88; }

/* ‚îÄ‚îÄ BOSHQA (settings) ‚îÄ‚îÄ */
.settings-list {
  display:flex;
  flex-direction:column;
  gap:8px;
}
.setting-item {
  background:var(--surface);
  border-radius:13px;
  padding:14px;
  display:flex;
  cursor: pointer;
  align-items:center;
  justify-content:space-between;
  box-shadow:0 1px 5px rgba(44,40,37,0.05);
}

.setting-item:active { transform:scale(0.98); opacity:0.88; }

.setting-info { flex:1; }
.setting-name { font-size:14px; font-weight:700; color:var(--text); }
.setting-desc { font-size:11px; color:var(--text3); margin-top:2px; }
.setting-action {
  background:var(--accent-l);
  color:var(--accent);
  border:1.5px solid var(--accent);
  border-radius:10px;
  padding:8px 14px;
  font-size:12px;
  font-weight:800;
  cursor:pointer;
}
.setting-action.disabled {
  background:var(--surface2);
  color:var(--text3);
  border-color:var(--border);
  cursor:not-allowed;
}

/* CAT colors - Expense */
.ic-oziq      { background:#E8F5E9; }
.ic-transport { background:#E3F2FD; }
.ic-kommunal  { background:#FFF8E1; }
.ic-soglik    { background:#FCE4EC; }
.ic-kiyim     { background:#F3E5F5; }
.ic-uy        { background:#E0F2F1; }
.ic-ta ºlim    { background:#FFF3E0; }
.ic-ko ºngil   { background:#F3E5F5; }
.ic-boshqa    { background:#ECEFF1; }

/* CAT colors - Income */
.ic-maosh     { background:#E8F5E9; }
.ic-bonus     { background:#FFF3E0; }
.ic-biznes    { background:#E3F2FD; }
.ic-investitsiya { background:#F3E5F5; }
.ic-sovg ºa    { background:#FCE4EC; }
.ic-boshqa-daromad { background:#ECEFF1; }

/* ‚îÄ‚îÄ MODAL (PIN / CONFIRM) ‚îÄ‚îÄ */
.modal-backdrop {
  position: fixed; inset:0;
  background: rgba(44,40,37,0.45);
  z-index: 100;
  display: flex; align-items: flex-end; justify-content: center;
  opacity:0; pointer-events:none;
  transition: opacity 0.2s;
}
.modal-backdrop.open { opacity:1; pointer-events:all; }

.modal-sheet {
  background: var(--surface);
  border-radius: 20px 20px 0 0;
  padding: 20px 20px 32px;
  width: 100%; max-width: 430px;
  transform: translateY(100%);
  transition: transform 0.25s cubic-bezier(.4,0,.2,1);
  display: flex; flex-direction:column; gap:14px;
}
.modal-backdrop.open .modal-sheet { transform: translateY(0); }

.modal-handle {
  width:36px; height:4px; border-radius:99px;
  background:var(--border); margin:0 auto -4px;
}
.modal-title { font-size:16px; font-weight:800; text-align:center; }
.modal-sub { font-size:13px; color:var(--text3); text-align:center; font-weight:600; line-height:1.4; }

.modal-btns { display:flex; gap:8px; }
.modal-btn {
  flex:1; padding:13px; border-radius:11px; border:none;
  font-family:'Nunito',sans-serif; font-size:14px; font-weight:800;
  cursor:pointer; transition:opacity 0.15s;
}
.modal-btn.cancel { background:var(--surface2); color:var(--text2); }
.modal-btn.confirm { background:var(--accent); color:white; }
.modal-btn.danger  { background:var(--red); color:white; }
.modal-btn:active  { opacity:0.85; }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast {
  position:fixed;
  bottom:calc(var(--nav-h) + 10px);
  left:50%; transform:translateX(-50%) translateY(8px);
  background:rgba(44,40,37,0.92); color:white;
  font-family:'Nunito',sans-serif; font-size:13px; font-weight:700;
  padding:9px 18px; border-radius:99px;
  z-index:1000; opacity:0; transition:all 0.22s;
  white-space:nowrap; pointer-events:none;
}
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* ‚îÄ‚îÄ CAT SECTION HEADER ‚îÄ‚îÄ */
.cat-section-header {
  font-size:11px;
  font-weight:800;
  color:var(--text3);
  text-transform:uppercase;
  letter-spacing:1px;
  margin-top:12px;
  margin-bottom:6px;
}
.cat-section-header:first-child {
  margin-top:0;
}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="logo">
    <span class="logo-ia">Fin</span>Track
  </div>
  <div class="topbar-right">
    <span id="clock-disp">--:--</span>
  </div>
</div>

<!-- PAGES -->
<div class="pages">

  <!-- DASHBOARD -->
  <div class="page active" id="page-dash">
    <div class="hero-card">
      <div class="hero-label">Balans</div>
      <div class="hero-amount" id="h-balance">0 UZS</div>
      <div class="hero-row">
        <div class="hero-stat">
          <div class="hero-stat-val" id="h-income">0</div>
          <div class="hero-stat-lbl">Daromad</div>
        </div>
        <div class="hero-stat">
          <div class="hero-stat-val" id="h-expense">0</div>
          <div class="hero-stat-lbl">Xarajat</div>
        </div>
      </div>
    </div>

    <div class="mini-stats">
      <div class="mini-card">
        <div class="mini-ico ic-oziq">üìÖ</div>
        <div class="mini-val" id="m-today">0</div>
        <div class="mini-lbl">Bugun (UZS)</div>
      </div>
      <div class="mini-card">
        <div class="mini-ico ic-transport">üèÜ</div>
        <div class="mini-val" id="m-topcat">‚Äî</div>
        <div class="mini-lbl">Asosiy kategoriya</div>
      </div>
    </div>

    <div>
      <div class="sec-title">So'nggi operatsiyalar</div>
      <div class="hist-list" id="dash-recent"></div>
    </div>
  </div>

  <!-- QO'SHISH -->
  <div class="page" id="page-add">
    <div class="card add-form">
      <div class="toggle-wrapper">
        <span class="toggle-label" id="toggle-label-expense" onclick="setEntryType('expense')">Expense</span>
        <span class="toggle-label active income-active" id="toggle-label-income" onclick="setEntryType('income')">Income</span>
      </div>
      
      <div class="sec-title" id="add-form-title">Yangi daromad</div>
      <div class="f-row">
        <div class="f-lbl">Tavsif</div>
        <input class="f-input" type="text" id="f-desc" placeholder="masalan: oylik maosh" maxlength="60" style="text-transform: lowercase;"/>
      </div>
      <div class="f-row">
        <div class="f-lbl">Miqdor</div>
        <div class="amt-wrap">
          <span class="cur">UZS</span>
          <input class="f-input" type="text" id="f-amount" placeholder="0" inputmode="numeric"/>
        </div>
      </div>
      <div class="f-row">
        <div class="f-lbl">Kategoriya</div>
        <div class="cat-grid" id="cat-grid">
          <!-- Populated dynamically -->
        </div>
      </div>
      <button class="add-btn" onclick="addEntry()">Qo'shish</button>
    </div>
  </div>

  <!-- TARIX -->
  <div class="page" id="page-hist">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <div class="sec-title" style="margin-bottom:0">Barcha operatsiyalar</div>
      <button onclick="openClearConfirm()" style="font-family:'Nunito',sans-serif;font-size:11px;font-weight:800;color:var(--red);background:none;border:none;cursor:pointer;">Tozalash</button>
    </div>
    <div class="filter-row">
      <button class="filter-btn" id="filter-date-btn" onclick="toggleDateFilter()">üìÖ Kun bo'yicha</button>
      <button class="filter-btn" id="filter-cat-btn" onclick="openCatFilter()">üìÇ Kategoriya</button>
    </div>
    <div class="filter-type-row">
      <button class="filter-type-btn sel" id="filter-type-all" onclick="setTypeFilter('all')">Hammasi</button>
      <button class="filter-type-btn" id="filter-type-income" onclick="setTypeFilter('income')">Daromad</button>
      <button class="filter-type-btn" id="filter-type-expense" onclick="setTypeFilter('expense')">Xarajat</button>
    </div>
    <div id="date-filter-section" style="display:none; margin-top:8px;">
      <div style="display:flex; gap:6px; margin-bottom:8px;">
        <input type="date" id="filter-date-start" class="f-input" style="flex:1; padding:10px 8px; font-size:13px; font-weight:600;"/>
        <input type="date" id="filter-date-end" class="f-input" style="flex:1; padding:10px 8px; font-size:13px; font-weight:600;"/>
      </div>
      <div style="display:flex; gap:6px;">
        <button class="modal-btn cancel" style="flex:1; font-size:12px; padding:8px;" onclick="clearDateFilter()">Tozalash</button>
        <button class="modal-btn confirm" style="flex:1; font-size:12px; padding:8px;" onclick="applyDateFilter()">Qo'llash</button>
      </div>
    </div>
    <div class="hist-list" id="hist-list"></div>
  </div>

  <!-- BOSHQA (settings) -->
  <div class="page" id="page-other">
    <div class="balance-prog-card">
      <div class="balance-prog-title">Moliyaviy holat</div>
      <div class="balance-prog-bar-wrap">
        <div class="balance-prog-expense" id="balance-prog-expense"></div>
      </div>
      <div class="balance-prog-labels">
        <div class="balance-prog-label">
          <div class="balance-prog-label-name">Balans</div>
          <div class="balance-prog-label-val" id="balance-income-val" style="color: #4A7C59;">0</div>
        </div>
        <div class="balance-prog-label">
          <div class="balance-prog-label-name">Xarajat</div>
          <div class="balance-prog-label-val" id="balance-expense-val" style="color: #C0392B;">0</div>
        </div>
      </div>
    </div>

    <div class="settings-list">
      <div class="sec-title">Sozlamalar</div>
      <div class="setting-item">
        <div class="setting-info">
          <div class="setting-name">Bildirishnomalar</div>
          <div class="setting-desc">Balans manfiy bo'lganda ogohlantir</div>
        </div>
        <button class="setting-action disabled">Tez orada</button>
      </div>
      <div class="setting-item">
        <div class="setting-info">
          <div class="setting-name">Davr</div>
          <div class="setting-desc">Haftalik/Oylik/Yillik</div>
        </div>
        <button class="setting-action disabled">Tez orada</button>
      </div>
      <div class="setting-item">
        <div class="setting-info">
          <div class="setting-name">Export</div>
          <div class="setting-desc">Ma'lumotlarni yuklab olish</div>
        </div>
        <button class="setting-action disabled">Tez orada</button>
      </div>
    </div>
  </div>

</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-btn active" onclick="goPage('dash',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>
    Dashboard
  </button>
  <button class="nav-btn" onclick="goPage('add',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="9"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
    Qo'shish
  </button>
  <button class="nav-btn" onclick="goPage('hist',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
    Tarix
  </button>
  <button class="nav-btn" onclick="goPage('other',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M4.22 4.22l4.24 4.24m5.66 5.66l4.24 4.24M1 12h6m6 0h6M4.22 19.78l4.24-4.24m5.66-5.66l4.24-4.24"/></svg>
    Boshqa
  </button>
</nav>

<!-- MODAL: Edit Entry -->
<div class="modal-backdrop" id="modal-edit">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Tahrirlash</div>
    <div class="f-row">
      <div class="f-lbl">Miqdor</div>
      <div class="amt-wrap">
        <span class="cur">UZS</span>
        <input class="f-input" type="text" id="edit-amount" placeholder="0" inputmode="numeric"/>
      </div>
    </div>
    <div class="f-row">
      <div class="f-lbl">Kategoriya</div>
      <div class="cat-grid" id="edit-cat-grid">
        <!-- populated dynamically -->
      </div>
    </div>
    <div class="modal-btns">
      <button class="modal-btn cancel" onclick="closeModal('modal-edit')">Bekor</button>
      <button class="modal-btn confirm" onclick="saveEdit()">Saqlash</button>
    </div>
  </div>
</div>

<!-- MODAL: Delete confirm -->
<div class="modal-backdrop" id="modal-del">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">O'chirishni tasdiqlang</div>
    <div class="modal-sub" id="modal-del-desc">Bu operatsiyani o'chirmoqchimisiz?</div>
    <div class="modal-btns">
      <button class="modal-btn cancel" onclick="closeModal('modal-del')">Bekor</button>
      <button class="modal-btn danger" onclick="confirmDelete()">O'chirish</button>
    </div>
  </div>
</div>

<!-- MODAL: Clear all -->
<div class="modal-backdrop" id="modal-clear">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Hammasini o'chirish</div>
    <div class="modal-sub">Barcha operatsiyalarni o'chirmoqchimisiz?</div>
    <div class="modal-btns">
      <button class="modal-btn cancel" onclick="closeModal('modal-clear')">Bekor</button>
      <button class="modal-btn danger" onclick="confirmClear()">Hammani o'chirish</button>
    </div>
  </div>
</div>

<!-- MODAL: Category filter -->
<div class="modal-backdrop" id="modal-cat-filter">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-title">Kategoriya tanlang</div>
      
      <div class="cat-grid" id="filter-cat-grid">
        </div>
      
      <div class="modal-btns">
        <button class="modal-btn cancel" onclick="clearCatFilter()">Tozalash</button>
        <button class="modal-btn confirm" onclick="closeModal('modal-cat-filter')">Yopish</button>
      </div>
    </div>
  </div>

<div class="toast" id="toast"></div>

<script>
const EXPENSE_CATS = {
  oziq:      { label:'Oziq-ovqat', ico:'üåæ', ic:'ic-oziq' },
  transport: { label:'Transport',  ico:'üöå', ic:'ic-transport' },
  kommunal:  { label:'Kommunal',   ico:'üí°', ic:'ic-kommunal' },
  soglik:    { label:"Sog'liq",    ico:'üíä', ic:'ic-soglik' },
  kiyim:     { label:'Kiyim',      ico:'üëî', ic:'ic-kiyim' },
  uy:        { label:'Uy-joy',     ico:'üè†', ic:'ic-uy' },
  ta ºlim:    { label:"Ta'lim",     ico:'üìö', ic:'ic-ta ºlim' },
  ko ºngil:   { label:"Ko'ngil",    ico:'üéÆ', ic:'ic-ko ºngil' },
  boshqa:    { label:'Boshqa',     ico:'üì¶', ic:'ic-boshqa' },
};

const INCOME_CATS = {
  maosh:     { label:'Maosh',       ico:'üí∞', ic:'ic-maosh' },
  bonus:     { label:'Bonus',       ico:'üéÅ', ic:'ic-bonus' },
  biznes:    { label:'Biznes',      ico:'üíº', ic:'ic-biznes' },
  investitsiya: { label:'Investitsiya', ico:'üìà', ic:'ic-investitsiya' },
  sovg ºa:    { label:"Sovg'a",      ico:'üéâ', ic:'ic-sovg ºa' },
  boshqa:    { label:'Boshqa',      ico:'üíµ', ic:'ic-boshqa-daromad' },
};

let entries = [];
let entryType = 'income'; // 'income' or 'expense'
let selCat = 'maosh';
let editingId = null;
let pendingDeleteId = null;
let editCat = 'maosh';
let filterDateStart = null;
let filterDateEnd = null;
let filterCats = new Set();
let filterType = 'all'; // 'all', 'income', 'expense'

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄÔøΩÔøΩ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmt(n) {
  if (n >= 1000000) return (n/1000000).toFixed(1).replace('.0','') + 'M';
  if (n >= 1000)    return Math.round(n/1000) + 'K';
  return Math.round(n).toString();
}
function fmtFull(n) { return Math.round(n).toLocaleString('uz-UZ'); }
function today()    { return new Date().toISOString().slice(0,10); }

function dateLabel(iso) {
  if (iso === today()) return 'Bugun';
  const y = new Date(); y.setDate(y.getDate()-1);
  if (iso === y.toISOString().slice(0,10)) return 'Kecha';
  return new Date(iso).toLocaleDateString('uz-UZ', {day:'numeric', month:'short'});
}

function formatInputNumber(val) {
  return val.replace(/\D/g,'').replace(/\B(?=(\d{3})+(?!\d))/g,' ');
}

// ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveLocal() {
  localStorage.setItem('x_entries5', JSON.stringify(entries));
}

function loadLocal() {
  entries = JSON.parse(localStorage.getItem('x_entries5') || '[]');
  renderDash();
  renderProgressBar();
}

// ‚îÄ‚îÄ TOGGLE ENTRY TYPE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setEntryType(type) {
  entryType = type;
  
  const expenseLabel = document.getElementById('toggle-label-expense');
  const incomeLabel = document.getElementById('toggle-label-income');
  const formTitle = document.getElementById('add-form-title');
  const descInput = document.getElementById('f-desc');
  
  if (type === 'income') {
    expenseLabel.classList.remove('active');
    incomeLabel.classList.add('active', 'income-active');
    formTitle.textContent = 'Yangi daromad';
    descInput.placeholder = 'masalan: oylik maosh';
    selCat = 'maosh';
  } else {
    incomeLabel.classList.remove('active', 'income-active');
    expenseLabel.classList.add('active');
    formTitle.textContent = 'Yangi xarajat';
    descInput.placeholder = 'masalan: non va sut';
    selCat = 'oziq';
  }
  
  renderCategoryGrid();
}

function renderCategoryGrid() {
  const grid = document.getElementById('cat-grid');
  const cats = entryType === 'income' ? INCOME_CATS : EXPENSE_CATS;
  
  grid.innerHTML = Object.entries(cats).map(([key, c]) => 
    `<div class="cat-item ${key===selCat?'sel':''}" data-cat="${key}" onclick="selectCat('${key}')">
      <span class="ico">${c.ico}</span>${c.label}
    </div>`
  ).join('');
}

function selectCat(cat) {
  selCat = cat;
  renderCategoryGrid();
}

// ‚îÄ‚îÄ TYPE FILTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setTypeFilter(type) {
  filterType = type;
  
  document.getElementById('filter-type-all').classList.toggle('sel', type === 'all');
  document.getElementById('filter-type-income').classList.toggle('sel', type === 'income');
  document.getElementById('filter-type-expense').classList.toggle('sel', type === 'expense');
  
  renderHist();
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function goPage(name, btn) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  btn.classList.add('active');
  if (name==='dash')  renderDash();
  if (name==='hist')  renderHist();
  if (name==='other') renderProgressBar();
}

// Amount input formatting
const amtInput = document.getElementById('f-amount');
amtInput.addEventListener('input', e => {
  e.target.value = formatInputNumber(e.target.value);
});

// ‚îÄ‚îÄ ADD ENTRY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addEntry() {
  const desc   = document.getElementById('f-desc').value.trim();
  const amtStr = document.getElementById('f-amount').value.replace(/\s/g,'');
  const amount = parseFloat(amtStr);
  if (!desc)               { toast('Tavsif kiriting'); return; }
  if (!amount || amount<=0){ toast("To'g'ri miqdor kiriting"); return; }

  entries.unshift({ 
    id: Date.now(), 
    desc, 
    amount, 
    cat: selCat, 
    type: entryType,
    date: today() 
  });
  
  saveLocal();
  document.getElementById('f-desc').value   = '';
  document.getElementById('f-amount').value = '';
  renderDash();
  renderProgressBar();
  toast(entryType === 'income' ? "‚úì Daromad qo'shildi" : "‚úì Xarajat qo'shildi");
}

// ‚îÄ‚îÄ EDIT / DELETE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let longPressTimer;
let activeContextId = null;

function handleEntryClick(id, event) {
  if (!('ontouchstart' in window)) {
    event.stopPropagation();
    if (activeContextId === id) {
      hideAllContexts();
    } else {
      showContext(id);
    }
  }
}

function handleTouchStart(id) {
  longPressTimer = setTimeout(() => showContext(id), 500);
}

function handleTouchEnd() {
  clearTimeout(longPressTimer);
}

function showContext(id) {
  hideAllContexts();
  activeContextId = id;
  const card = document.querySelector(`[data-entry-id="${id}"]`);
  if (!card) return;
  
  const ctx = document.createElement('div');
  ctx.className = 'entry-context';
  ctx.id = 'ctx-' + id;
  ctx.innerHTML = `
    <button class="entry-context-btn edit" onclick="openEditModal(${id})">Tahrirlash</button>
    <button class="entry-context-btn delete" onclick="openDeleteConfirm(${id})">O'chirish</button>
  `;
  card.appendChild(ctx);
}

function hideAllContexts() {
  document.querySelectorAll('.entry-context').forEach(el=>el.remove());
  activeContextId = null;
}

function openEditModal(id) {
  hideAllContexts();
  editingId = id;
  const e = entries.find(x=>x.id===id);
  if (!e) return;
  document.getElementById('edit-amount').value = formatInputNumber(String(e.amount));
  editCat = e.cat;
  
  const cats = e.type === 'income' ? INCOME_CATS : EXPENSE_CATS;
  const grid = document.getElementById('edit-cat-grid');
  grid.innerHTML = Object.entries(cats).map(([key, c]) => 
    `<div class="cat-item ${key===editCat?'sel':''}" data-cat="${key}" onclick="selectEditCat('${key}')">
      <span class="ico">${c.ico}</span>${c.label}
    </div>`
  ).join('');
  
  openModal('modal-edit');
}

function selectEditCat(cat) {
  editCat = cat;
  document.querySelectorAll('#edit-cat-grid .cat-item').forEach(x=>x.classList.remove('sel'));
  document.querySelector(`#edit-cat-grid [data-cat="${cat}"]`).classList.add('sel');
}

const editAmtInput = document.getElementById('edit-amount');
editAmtInput.addEventListener('input', e => {
  e.target.value = formatInputNumber(e.target.value);
});

function saveEdit() {
  if (editingId === null) return;
  const amtStr = document.getElementById('edit-amount').value.replace(/\s/g,'');
  const amount = parseFloat(amtStr);
  if (!amount || amount<=0) { toast("To'g'ri miqdor kiriting"); return; }
  
  const e = entries.find(x=>x.id===editingId);
  if (!e) return;
  e.amount = amount;
  e.cat = editCat;
  saveLocal();
  closeModal('modal-edit');
  renderDash();
  renderHist();
  renderProgressBar();
  toast('‚úì Tahrirlandi');
  editingId = null;
}

function openDeleteConfirm(id) {
  hideAllContexts();
  pendingDeleteId = id;
  const e = entries.find(x=>x.id===id);
  document.getElementById('modal-del-desc').textContent =
    e ? `"${e.desc}" ‚Äî ${fmtFull(e.amount)} UZS ni o'chirmoqchimisiz?`
      : "Bu operatsiyani o'chirmoqchimisiz?";
  openModal('modal-del');
}

function confirmDelete() {
  if (pendingDeleteId === null) return;
  const id = pendingDeleteId;
  pendingDeleteId = null;
  closeModal('modal-del');
  entries = entries.filter(e=>e.id!==id);
  saveLocal();
  renderDash(); 
  renderHist();
  renderProgressBar();
  toast("O'chirildi");
}

function openClearConfirm() {
  if (!entries.length) { toast("Jurnal bo'sh"); return; }
  openModal('modal-clear');
}

function confirmClear() {
  closeModal('modal-clear');
  entries = [];
  saveLocal();
  renderDash(); 
  renderHist();
  renderProgressBar();
  toast('Tozalandi');
}

// ‚îÄ‚îÄ MODAL HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

document.querySelectorAll('.modal-backdrop').forEach(el => {
  el.addEventListener('click', e => { if (e.target===el) closeModal(el.id); });
});

// ‚îÄ‚îÄ ENTRY HTML ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function entryHTML(e, allowContext = false) {
  const cats = e.type === 'income' ? INCOME_CATS : EXPENSE_CATS;
  const c = cats[e.cat] || cats.boshqa;
  const typeClass = e.type === 'income' ? 'income' : 'expense';
  const contextAttr = allowContext ? `data-entry-id="${e.id}" class="entry-card clickable ${typeClass}"` : `class="entry-card ${typeClass}"`;
  
  const contextEvent = allowContext 
    ? `onclick="handleEntryClick(${e.id}, event)" ontouchstart="handleTouchStart(${e.id})" ontouchend="handleTouchEnd()" ontouchcancel="handleTouchEnd()"`
    : '';
  
  const sign = e.type === 'income' ? '+' : '‚àí';
  
  return `<div ${contextAttr} ${contextEvent}>
    <div class="entry-ico ${c.ic}">${c.ico}</div>
    <div class="entry-info">
      <div class="entry-desc">${e.desc}</div>
      <div class="entry-meta">${dateLabel(e.date)} ¬∑ ${c.label}</div>
    </div>
    <div class="entry-right">
      <div class="entry-amt ${typeClass}">${sign}${fmtFull(e.amount)}</div>
    </div>
  </div>`;
}

// ‚îÄ‚îÄ RENDER DASH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDash() {
  const income = entries.filter(e=>e.type==='income').reduce((s,e)=>s+e.amount,0);
  const expense = entries.filter(e=>e.type==='expense').reduce((s,e)=>s+e.amount,0);
  const balance = income - expense;
  
  document.getElementById('h-balance').textContent = fmtFull(balance)+' UZS';
  document.getElementById('h-income').textContent = fmt(income);
  document.getElementById('h-expense').textContent = fmt(expense);

  const todayIncome = entries.filter(e=>e.date===today() && e.type==='income').reduce((s,e)=>s+e.amount,0);
  const todayExpense = entries.filter(e=>e.date===today() && e.type==='expense').reduce((s,e)=>s+e.amount,0);
  const todayNet = todayIncome - todayExpense;
  document.getElementById('m-today').textContent = fmt(todayNet);

  const expenseEntries = entries.filter(e=>e.type==='expense');
  const catT={};
  expenseEntries.forEach(e=>{ catT[e.cat]=(catT[e.cat]||0)+e.amount; });
  const top = Object.entries(catT).sort((a,b)=>b[1]-a[1])[0];
  document.getElementById('m-topcat').textContent = top ? EXPENSE_CATS[top[0]]?.ico || '‚Äî' : '‚Äî';

  const el  = document.getElementById('dash-recent');
  const rec = entries.slice(0,3);
  el.innerHTML = rec.length
    ? rec.map(e=>entryHTML(e, false)).join('')
    : '<div class="empty-msg"><div class="big">üå±</div>Hali operatsiya yo\'q</div>';
}

// ‚îÄ‚îÄ RENDER HIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHist() {
  let filtered = [...entries];
  
  // Apply type filter
  if (filterType !== 'all') {
    filtered = filtered.filter(e => e.type === filterType);
  }
  
  // Apply date filter
  if (filterDateStart || filterDateEnd) {
    filtered = filtered.filter(e => {
      if (filterDateStart && e.date < filterDateStart) return false;
      if (filterDateEnd && e.date > filterDateEnd) return false;
      return true;
    });
  }
  
  // Apply category filter
  if (filterCats.size > 0) {
    filtered = filtered.filter(e => filterCats.has(e.cat));
  }
  
  const el = document.getElementById('hist-list');
  el.innerHTML = filtered.length
    ? filtered.map(e=>entryHTML(e, true)).join('')
    : '<div class="empty-msg"><div class="big">üìã</div>Hali operatsiya yo\'q</div>';
}

// ‚îÄ‚îÄ PROGRESS BAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderProgressBar() {
  const income = entries.filter(e=>e.type==='income').reduce((s,e)=>s+e.amount,0);
  const expense = entries.filter(e=>e.type==='expense').reduce((s,e)=>s+e.amount,0);
  const balance = income - expense;
  
  document.getElementById('balance-expense-val').textContent = fmt(expense);
  document.getElementById('balance-income-val').textContent = fmt(balance); // Show balance, not income
  
  const expenseBar = document.getElementById('balance-prog-expense');
  if (income === 0) {
    expenseBar.style.width = '0%';
  } else {
    const pct = Math.min((expense / income) * 100, 100);
    expenseBar.style.width = pct + '%';
  }
}

// ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleDateFilter() {
  const section = document.getElementById('date-filter-section');
  const btn = document.getElementById('filter-date-btn');
  const isOpen = section.style.display === 'block';
  section.style.display = isOpen ? 'none' : 'block';
  btn.classList.toggle('active', !isOpen);
}

function applyDateFilter() {
  filterDateStart = document.getElementById('filter-date-start').value || null;
  filterDateEnd = document.getElementById('filter-date-end').value || null;
  renderHist();
  const btn = document.getElementById('filter-date-btn');
  btn.classList.toggle('active', filterDateStart || filterDateEnd);
}

function clearDateFilter() {
  filterDateStart = null;
  filterDateEnd = null;
  document.getElementById('filter-date-start').value = '';
  document.getElementById('filter-date-end').value = '';
  document.getElementById('date-filter-section').style.display = 'none';
  document.getElementById('filter-date-btn').classList.remove('active');
  renderHist();
}

function openCatFilter() {
  const grid = document.getElementById('filter-cat-grid');
  let html = '';
  
  // Show all categories if type filter is 'all'
  // Show only expense categories if type filter is 'expense'
  // Show only income categories if type filter is 'income'
  
  if (filterType === 'all' || filterType === 'expense') {
    html += '<div class="cat-section-header">Xarajat Kategoriyalari</div>';
    html += Object.entries(EXPENSE_CATS).map(([key, c]) => 
      `<div class="cat-item ${filterCats.has(key)?'sel':''}" data-cat="${key}" onclick="toggleFilterCat('${key}')">
        <span class="ico">${c.ico}</span>${c.label}
      </div>`
    ).join('');
  }
  
  if (filterType === 'all' || filterType === 'income') {
    html += '<div class="cat-section-header">Daromad Kategoriyalari</div>';
    html += Object.entries(INCOME_CATS).map(([key, c]) => 
      `<div class="cat-item ${filterCats.has(key)?'sel':''}" data-cat="${key}" onclick="toggleFilterCat('${key}')">
        <span class="ico">${c.ico}</span>${c.label}
      </div>`
    ).join('');
  }
  
  grid.innerHTML = html;
  openModal('modal-cat-filter');
}

function toggleFilterCat(cat) {
  if (filterCats.has(cat)) {
    filterCats.delete(cat);
  } else {
    filterCats.add(cat);
  }
  const el = document.querySelector(`#filter-cat-grid [data-cat="${cat}"]`);
  el.classList.toggle('sel');
  renderHist();
  const btn = document.getElementById('filter-cat-btn');
  btn.classList.toggle('active', filterCats.size > 0);
}

function clearCatFilter() {
  filterCats.clear();
  const grid = document.getElementById('filter-cat-grid');
  grid.querySelectorAll('.cat-item').forEach(el => el.classList.remove('sel'));
  renderHist();
  document.getElementById('filter-cat-btn').classList.remove('active');
  closeModal('modal-cat-filter');
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let toastT;
function toast(msg) {
  const el=document.getElementById('toast');
  el.textContent=msg;
  el.classList.add('show');
  clearTimeout(toastT);
  toastT=setTimeout(()=>el.classList.remove('show'),2000);
}

// ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tick() {
  const n=new Date();
  const t=String(n.getHours()).padStart(2,'0')+':'+String(n.getMinutes()).padStart(2,'0');
  document.getElementById('clock-disp').textContent=t;
}
tick();
setInterval(tick, 10000);

// ‚îÄ‚îÄ ENTER KEY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e=>{
  if (e.key==='Enter' && ['f-desc','f-amount'].includes(document.activeElement.id)) addEntry();
});

// Hide context menu when clicking outside
document.addEventListener('click', e => {
  if (!e.target.closest('.entry-context') && !e.target.closest('.entry-card')) {
    hideAllContexts();
  }
});

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
renderCategoryGrid();
loadLocal();
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').catch(console.warn);
    });
  }
</script>
</body>
</html>
